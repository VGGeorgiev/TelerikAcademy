function getServerMessage(){if(sessionID!=null&&sessionID!="logout"){performGetRequest(serviceUrl+"get-next-message/"+sessionID,proccessServerMsg,function(e){var t=JSON.parse(e.responseText);if(t.errorCode=="ERR_SESSIONID"){DisplayErrorMessage("Can not connect to server! Maybe you are logout!");Logout.NavButtonClick();interval=window.clearInterval(interval)}else if(t.errorCode=="ERR_GENERAL"){DisplayErrorMessage("Server error. Can not connect to server!");interval=window.clearInterval(interval)}})}}function proccessServerMsg(e){var t=e.msgText;var n=e.username;var r=e.msgType;if(t!=null){if(r=="MSG_USER_ONLINE"){DisplayInfoMessage("<span>"+n+"</span> logged in the system.");UsersList.Refresh()}else if(r=="MSG_USER_OFFLINE"){DisplayInfoMessage("<span>"+n+"</span> logged out the system.");UsersList.Refresh()}else if(r=="MSG_CHALLENGE"){var i=confirm("Do you want to chat with "+n);if(i){Username=n;Chat.ResponseInvite(n,t)}else{Chat.Cancel(n)}}else if(r=="MSG_RESPONSE"){Username=n;var s=GibberishAES.dec(t,secretKey);if(s==999999999-randomNumber){Chat.Start(n)}else{Chat.Cancel(n)}}else if(r=="MSG_START_CHAT"){DisplayInfoMessage("You are starting chat with: "+"<span>"+n+"</span>");$("#close-chat-session").removeClass("hidden");$("#close-chat-session").on("click",Chat.Cancel)}else if(r=="MSG_CANCEL_CHAT"){DisplayInfoMessage(e.msgText+"by: "+"<span>"+n+"</span>");$("#close-chat-session").addClass("hidden")}else if(r=="MSG_CHAT_MESSAGE"){Message.Recieve(e)}}}function onUserClickSendInvite(e){$(".selected").removeClass("selected");$(this).addClass("selected");secretKey=prompt("Enter your secret key:");var t=GibberishAES.enc(randomNumber,secretKey);var n=document.querySelector(".selected");n=n.innerHTML;var r={sessionID:sessionID,recipientUsername:n,challenge:t};performPostRequest(serviceUrl+"invite-user",r,DisplayInfoMessage("You are send invite to: "+"<span>"+n+"</span>"),function(e){var t=JSON.parse(e.responseText);if(t.errorCode=="ERR_AUTO_CHAT"){DisplayErrorMessage("You can not chat with yourself!")}else if(t.errorCode=="ERR_USER_OFF"){DisplayErrorMessage("The user is offline!")}else if(t.errorCode=="ERR_BAD_USER"){DisplayErrorMessage(t.errorMsg)}else if(t.errorCode=="ERR_SESSIONID"){DisplayErrorMessage(t.errorMsg)}else if(t.errorCode=="ERR_BAD_CHALL"){DisplayErrorMessage(t.errorMsg)}})}function DisplayErrorMessage(e){var t=document.getElementById("info-msg-container");t.scrollTop=t.scrollHeight;t.innerHTML+='<p class="error-msg"><span>Error: </span>'+e+"</p>"}function DisplayInfoMessage(e){var t=document.getElementById("info-msg-container");t.scrollTop=t.scrollHeight;t.innerHTML+='<p class="info-msg">Information: '+e+"</p>"}function DisplayLoginErrors(e){var t=document.getElementById("login-form");t.innerHTML+='<p class="error-msg"><span>Error: </span>'+e+"</p>"}function DisplayRegisterErrors(e){var t=document.getElementById("reg-form");t.innerHTML+='<p class="error-msg"><span>Error: </span>'+e+"</p>"}function performPostRequest(e,t,n,r){$.ajax({url:e,type:"POST",contentType:"application/json",timeout:5e3,dataType:"json",data:JSON.stringify(t),success:n,error:r})}function performGetRequest(e,t,n){$.ajax({url:e,type:"GET",timeout:5e3,dataType:"json",success:t,error:n})}var serviceUrl="http://cryptochat.apphb.com/CryptoChatService.svc/";$.support.cors=true;var sessionID;var Username;var randomNumber=Math.floor(Math.random()*999999999);var secretKey;$(document).ready(function(){Login.NavButtonClick();$("#reg-nav-btn").on("click",Register.NavButtonClick);$("#login-nav-btn").on("click",Login.NavButtonClick);$("#logout-nav-btn").on("click",Logout.NavButtonClick);$("#input-msg-box").on("click",Message.Send)});$(document).keyup(function(e){if($("#input-msg").is(":focus")&&e.keyCode==13){Message.Send()}$("#msg").submit(function(){return false})});var interval=setInterval(getServerMessage,1e3);var Chat=new Object;Chat.Start=function(e){var t={sessionID:sessionID,recipientUsername:e};performPostRequest(serviceUrl+"start-chat",t,function(){DisplayInfoMessage("You are start chat with: "+"<span>"+e+"</span>");$("#close-chat-session").removeClass("hidden");$("#close-chat-session").on("click",Chat.Cancel);document.getElementById("chat-messages").innerHTML=""},Chat.StartErrors)};Chat.StartErrors=function(e){var t=JSON.parse(e.responseText);DisplayErrorMessage("You can't start chat. "+t.errorMsg)};Chat.Cancel=function(e){var t={sessionID:sessionID,recipientUsername:Username};performPostRequest(serviceUrl+"cancel-chat",t,function(){DisplayInfoMessage("You are cancel chat with: "+"<span>"+Username+"</span>");$("#close-chat-session").addClass("hidden")},Chat.CancelErrors)};Chat.CancelErrors=function(e){var t=JSON.parse(e.responseText);if(t.errorCode=="ERR_SESSIONID"){DisplayErrorMessage("There is a error with canceling chat. "+t.errorMsg)}else if(t.errorCode=="ERR_BAD_USER"){DisplayErrorMessage("You can't cancel chat with this user. "+t.errorMsg)}else if(t.errorCode=="ERR_USER_OFF"){DisplayErrorMessage(Username+" is offline!")}else if(t.errorCode=="ERR_GENERAL"){DisplayErrorMessage("Can not cancel chat. There is a server error. Please try again.")}};Chat.ResponseInvite=function(e,t){secretKey=prompt("Enter "+e+" secret key:");if(n>999999999||n<0){DisplayErrorMessage("The key with "+e+" is wrong!")}var n=GibberishAES.dec(t,secretKey);var r=GibberishAES.enc(999999999-n,secretKey);var i={sessionID:sessionID,recipientUsername:e,response:r};performPostRequest(serviceUrl+"response-chat-invitation",i,function(){console.log("Response send!")},Chat.ResponseInviteErrors)};Chat.ResponseInviteErrors=function(e){var t=JSON.parse(e.responseText);DisplayErrorMessage("You can't send invitation response. "+t.errorMsg)};var Message=new Object;Message.Send=function(){var e=$("#input-msg").val();var t=document.getElementById("chat-messages");t.scrollTop=t.scrollHeight;t.innerHTML+='<p class="msg-send"><span>Me: </span>'+e+"</p>";var n=GibberishAES.enc(e,secretKey);var r={sessionID:sessionID,recipientUsername:Username,encryptedMsg:n};performPostRequest(serviceUrl+"send-chat-message",r,function(){},Message.SendErrors);document.getElementById("input-msg").value=""};Message.Recieve=function(e){var t=e.msgText;var n=e.username;var r=GibberishAES.dec(t,secretKey);var i=document.getElementById("chat-messages");i.scrollTop=i.scrollHeight;i.innerHTML+='<p class="msg-recieve"><span>'+n+": </span>"+r+"</p>"};Message.SendErrors=function(e){var t=JSON.parse(e.responseText);if(t.errorCode=="ERR_BAD_USER"){DisplayErrorMessage("You can't send message. "+t.errorMsg)}else if(t.errorCode=="ERR_USER_OFF"){DisplayErrorMessage("You can't send message. "+t.errorMsg)}else if(t.errorCode=="ERR_BAD_MSG"){DisplayErrorMessage("You can't send message. Maybe message is to long.")}else if(t.errorCode=="ERR_INVALID_STATE"){DisplayErrorMessage("You can't send message. "+t.errorMsg)}else if(t.errorCode=="ERR_GENERAL"){DisplayErrorMessage("You can't send message. Sever error. Maybe you have no active chat session.")}};var UsersList=new Object;UsersList.Refresh=function(){performGetRequest(serviceUrl+"list-users/"+sessionID,UsersList.onLoad,UsersList.Errors)};UsersList.onLoad=function(e){var t="<ul>";for(var n=0;n<e.length;n++){var r=e[n];t+="<li>"+'<a href="#" class="user">'+r+"</a>"+"</li>"}t+="</ul>";$("#users-wrapper").html(t);$("#users-wrapper ul a").on("click",onUserClickSendInvite)};UsersList.Errors=function(e){var t=JSON.parse(e.responseText);if(t.errorCode=="ERR_SESSIONID"){DisplayErrorMessage("Can not load the users. Invalid sessionID")}else{DisplayErrorMessage("Can not load the users. There is a server error. Please try again.")}};var Logout=new Object;Logout.NavButtonClick=function(){performGetRequest(serviceUrl+"logout/"+sessionID,function(){$("#logout-nav-btn").addClass("hidden");$("#reg-nav-btn").removeClass("hidden");$("#login-nav-btn").removeClass("hidden");$("#close-chat-session").addClass("hidden");var e="<p>Have a nice day!</p>";$("#main-content").html(e);$("#users-wrapper").html("");$("#msg").addClass("hidden");$("aside").addClass("hidden");$("footer").addClass("hidden");$("#info-messages").addClass("hidden");sessionID="logout"},Logout.Errors)};Logout.Errors=function(e){var t=JSON.parse(e.responseText);if(t.errorCode=="ERR_SESSIONID"){DisplayErrorMessage("Can not logout. Invalid sessionID")}else if(t.errorCode=="ERR_GENERAL"){DisplayErrorMessage("Can not logout. There is a server error. Please try again.")}};var Login=new Object;Login.NavButtonClick=function(){var e='<form id="login-form">'+'<label for="tb-username">Username:</label>'+'<input id="tb-username" type="text" autofocus="autofocus" /><br />'+'<label for="tb-pass">Password:</label>'+'<input id="tb-pass" type="password" /><br />'+'<button id="login-button">Login</button>'+"</form>";$("#main-content").html(e);$("#login-button").on("click",Login.ButtonClick);$("#msg").addClass("hidden");$("aside").addClass("hidden");$("footer").addClass("hidden");$("#info-messages").addClass("hidden")};Login.ButtonClick=function(e){var t=$("#tb-username").val();var n=$("#tb-pass").val();myUsername=t;var r=CryptoJS.SHA1(t+n);var i={username:t,authCode:r.toString()};performPostRequest(serviceUrl+"login",i,Login.Success,Login.Errors);e.preventDefault()};Login.Success=function(e){sessionID=e.sessionID;$("#logout-nav-btn").removeClass("hidden");$("#reg-nav-btn").addClass("hidden");$("#login-nav-btn").addClass("hidden");var t='<div id="chat-messages"></div>';$("#main-content").removeClass("hidden");$("#msg").removeClass("hidden");$("aside").removeClass("hidden");$("footer").removeClass("hidden");$("#info-messages").removeClass("hidden");$("#main-content").html("<header>Chat with:</header>"+t);UsersList.Refresh();document.getElementById("chat-messages").value="";document.getElementById("info-msg-container").value=""};Login.Errors=function(e){var t=JSON.parse(e.responseText);if(t.errorCode=="ERR_INV_LOGIN"){DisplayLoginErrors(t.errorMsg)}else if(t.errorCode=="ERR_GENERAL"){DisplayLoginErrors("There is a server error. Please try again later.")}else if(t.errorCode=="ERR_AUTH_CODE"){DisplayLoginErrors(t.errorMsg)}else if(t.errorCode=="ERR_USR_NAME"){DisplayLoginErrors("Invalid username!")}setTimeout(Login.NavButtonClick,2e3)};var Register=new Object;Register.NavButtonClick=function(){var e='<form id="reg-form">'+'<label for="tb-username">Username:</label>'+'<input id="tb-username" type="text" autofocus="true"/><br />'+'<label for="tb-pass">Password:</label>'+'<input id="tb-pass" type="password" /><br />'+'<label for="tb-repeat-pass">Repeat Password:</label>'+'<input id="tb-repeat-pass" type="password" /><br />'+'<button id="reg-button">Register</button>'+"</form>";$("#main-content").html(e);$("#reg-button").on("click",Register.SendRegistration);$("#msg").addClass("hidden");$("aside").addClass("hidden");$("footer").addClass("hidden");$("#info-messages").addClass("hidden")};Register.SendRegistration=function(e){var t=$("#tb-username").val();var n=$("#tb-pass").val();if(n!=$("#tb-repeat-pass").val()){DisplayRegisterErrors("Passwords do not match!");return}if(n==""){DisplayRegisterErrors("Passwords can't be empty!");return}if(t==""||t.length>30){DisplayRegisterErrors("Username can not be empty or more than 30 symbols!");return}var r=CryptoJS.SHA1(t+n);var i={username:t,authCode:r.toString()};performPostRequest(serviceUrl+"register",i,Login.Success,Register.Errors);e.preventDefault()};Register.Errors=function(e){var t=JSON.parse(e.responseText);if(t.errorCode=="ERR_DUPLICATE"){DisplayRegisterErrors("The username is already taken!")}else if(t.errorCode=="ERR_USR_NAME"){DisplayRegisterErrors("Please insert a valid username!")}else if(t.errorCode=="ERR_GENERAL"){DisplayRegisterErrors("There is a server error. Please try again later.")}else if(t.errorCode=="ERR_AUTH_CODE"){DisplayRegisterErrors(t.errorMsg)}setTimeout(Register.NavButtonClick,2e3)}